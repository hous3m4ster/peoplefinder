<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: message_types/file_message.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: message_types/file_message.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

/************
 * Requires *
 ************/

var Message = require("./message");
var fs = require("fs");

/*************************
 * The FileMessage class *
 *************************/

/**
 * A message which contains a downloadable file, like a document or photo
 *
 * @extends Message
 */
class FileMessage extends Message {
	/**
	 * Creates a new FileMessage object
	 *
	 * @param {Object}Â message	A raw message object from an update
	 * @param {BotAPI} API	An instance of a BotAPI from teleapiwrapper which will be used to do stuff with this message
	 *
	 * @private
	 */
	constructor(message, API) {
		// Call the super constructor
		super(message, API);

		// Check if the message is actually a file message
		/**
		 * ID of the file in this message
		 *
		 * @private
		 */
		this._fileId = null;
		if (this.rawMessage.audio !== undefined) {
			this._fileId = this.rawMessage.audio.file_id;
		} else if (this.rawMessage.document !== undefined) {
			this._fileId = this.rawMessage.document.file_id;
		} else if (this.rawMessage.photo !== undefined) {
			// This will contain multiple images. AFAIK the last in the array is the original
			let photo = this.rawMessage.photo;
			this._fileId = photo[photo.length-1].file_id;
		} else if (this.rawMessage.sticker !== undefined) {
			this._fileId = this.rawMessage.sticker.file_id;
		} else if (this.rawMessage.video !== undefined) {
			this._fileId = this.rawMessage.video.file_id;
		} else if (this.rawMessage.voice !== undefined) {
			this._fileId = this.rawMessage.voide.file_id;
		}

		/**
		 * Info about the file in the form of a promise. Will be null before getFileInfo has been called
		 *
		 * @private
		 */
		this._fileInfoPromise = null;
	}

	/**
	 * The ID of the file in this message
	 *
	 * @type {String}
	 * @readonly
	 */
	get fileId() {
		return this._fileId;
	}

	/**
	 * Info about the file in the form of a promise which resolves to a [File]{@link https://core.telegram.org/bots/api#file} object
	 *
	 * @type {Promise}
	 * @readonly
	 */
	get fileInfoPromise() {
		if (this._fileInfoPromise === null) {
			this._fileInfoPromise = this._API.getFile(this._fileId);
		}
		return this._fileInfoPromise;
	}

	/**
	 * Downloads the file and puts it in a buffer. Be careful about using this method with large files
	 *
	 * @return {Promise}	A promise which resolves with a buffer containing the file when the file is downloaded
	 */
	getFile() {
		return this.getFileStream().then(fileStream => {
			return new Promise((resolve, reject) => {
				let buffer = null;
				fileStream.on("data", chunk => {
					if (buffer === null) {
						buffer = chunk;
					} else {
						buffer = buffer.concat(chunk);
					}
				});
				fileStream.on("end", () => resolve(buffer));
				fileStream.on("error", reject);
			});
		});
	}

	/**
	 * Gets a http stream to the file
	 *
	 * @return {Promise}	A promise which resolves with a stream containing the file
	 */
	getFileStream() {
		return this.fileInfoPromise.then(file => {
			return this._API.helperDownloadFile(file)
		});
	}


	/**
	 * Saves the file to disk
	 *
	 * @param {String} filename	The filename to save the file to 
	 *
	 * @return {Promise}	A promise which resolves when the file is saved
	 */
	saveFile(filename) {
		return this.getFileStream().then(fileStream => {
			return new Promise((resolve, reject) => {
				let ws = fs.createWriteStream(filename);

				fileStream.pipe(ws);
				ws.on("error", reject);
				fileStream.on("error", reject);
				fileStream.on("end", resolve);
			});
		});
	}
}

/***********
 * Exports *
 ***********/

module.exports = FileMessage;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AudioMessage.html">AudioMessage</a></li><li><a href="ChannelChatCreatedMessage.html">ChannelChatCreatedMessage</a></li><li><a href="ChatMigratedMessage.html">ChatMigratedMessage</a></li><li><a href="CommandMessage.html">CommandMessage</a></li><li><a href="ContactMessage.html">ContactMessage</a></li><li><a href="DeleteChatPhotoMessage.html">DeleteChatPhotoMessage</a></li><li><a href="DocumentMessage.html">DocumentMessage</a></li><li><a href="FileMessage.html">FileMessage</a></li><li><a href="ForwardedMessage.html">ForwardedMessage</a></li><li><a href="GroupChatCreatedMessage.html">GroupChatCreatedMessage</a></li><li><a href="LeftChatParticipantMessage.html">LeftChatParticipantMessage</a></li><li><a href="LocationMessage.html">LocationMessage</a></li><li><a href="Message.html">Message</a></li><li><a href="MessageSorter.html">MessageSorter</a></li><li><a href="NewChatParticipantMessage.html">NewChatParticipantMessage</a></li><li><a href="NewChatPhotoMessage.html">NewChatPhotoMessage</a></li><li><a href="NewChatTitleMessage.html">NewChatTitleMessage</a></li><li><a href="PhotoMessage.html">PhotoMessage</a></li><li><a href="ReplyMessage.html">ReplyMessage</a></li><li><a href="StickerMessage.html">StickerMessage</a></li><li><a href="SupergroupChatCreatedMessage.html">SupergroupChatCreatedMessage</a></li><li><a href="TelegramBot.html">TelegramBot</a></li><li><a href="TextMessage.html">TextMessage</a></li><li><a href="UpdateGetter.html">UpdateGetter</a></li><li><a href="VideoMessage.html">VideoMessage</a></li><li><a href="VoiceMessage.html">VoiceMessage</a></li></ul><h3>Events</h3><ul><li><a href="MessageSorter.html#event:audio">audio</a></li><li><a href="MessageSorter.html#event:channel_chat_created">channel_chat_created</a></li><li><a href="MessageSorter.html#event:chat_migrated">chat_migrated</a></li><li><a href="MessageSorter.html#event:chosen_inline_result">chosen_inline_result</a></li><li><a href="MessageSorter.html#event:command">command</a></li><li><a href="MessageSorter.html#event:contact">contact</a></li><li><a href="MessageSorter.html#event:delete_chat_photo">delete_chat_photo</a></li><li><a href="MessageSorter.html#event:document">document</a></li><li><a href="MessageSorter.html#event:error">error</a></li><li><a href="MessageSorter.html#event:file">file</a></li><li><a href="MessageSorter.html#event:forward">forward</a></li><li><a href="MessageSorter.html#event:group_chat_created">group_chat_created</a></li><li><a href="MessageSorter.html#event:inline_query">inline_query</a></li><li><a href="MessageSorter.html#event:left_chat_participant">left_chat_participant</a></li><li><a href="MessageSorter.html#event:location">location</a></li><li><a href="MessageSorter.html#event:message">message</a></li><li><a href="MessageSorter.html#event:multi_type">multi_type</a></li><li><a href="MessageSorter.html#event:new_chat_participant">new_chat_participant</a></li><li><a href="MessageSorter.html#event:new_chat_photo">new_chat_photo</a></li><li><a href="MessageSorter.html#event:new_chat_title">new_chat_title</a></li><li><a href="MessageSorter.html#event:photo">photo</a></li><li><a href="MessageSorter.html#event:reply">reply</a></li><li><a href="MessageSorter.html#event:sticker">sticker</a></li><li><a href="MessageSorter.html#event:supergroup_chat_created">supergroup_chat_created</a></li><li><a href="MessageSorter.html#event:text">text</a></li><li><a href="MessageSorter.html#event:update">update</a></li><li><a href="MessageSorter.html#event:video">video</a></li><li><a href="MessageSorter.html#event:voice">voice</a></li><li><a href="TelegramBot.html#event:audio">audio</a></li><li><a href="TelegramBot.html#event:channel_chat_created">channel_chat_created</a></li><li><a href="TelegramBot.html#event:chat_migrated">chat_migrated</a></li><li><a href="TelegramBot.html#event:chosen_inline_result">chosen_inline_result</a></li><li><a href="TelegramBot.html#event:command">command</a></li><li><a href="TelegramBot.html#event:contact">contact</a></li><li><a href="TelegramBot.html#event:delete_chat_photo">delete_chat_photo</a></li><li><a href="TelegramBot.html#event:document">document</a></li><li><a href="TelegramBot.html#event:error">error</a></li><li><a href="TelegramBot.html#event:file">file</a></li><li><a href="TelegramBot.html#event:forward">forward</a></li><li><a href="TelegramBot.html#event:group_chat_created">group_chat_created</a></li><li><a href="TelegramBot.html#event:inline_query">inline_query</a></li><li><a href="TelegramBot.html#event:left_chat_participant">left_chat_participant</a></li><li><a href="TelegramBot.html#event:location">location</a></li><li><a href="TelegramBot.html#event:message">message</a></li><li><a href="TelegramBot.html#event:multi_type">multi_type</a></li><li><a href="TelegramBot.html#event:new_chat_participant">new_chat_participant</a></li><li><a href="TelegramBot.html#event:new_chat_photo">new_chat_photo</a></li><li><a href="TelegramBot.html#event:new_chat_title">new_chat_title</a></li><li><a href="TelegramBot.html#event:photo">photo</a></li><li><a href="TelegramBot.html#event:reply">reply</a></li><li><a href="TelegramBot.html#event:sticker">sticker</a></li><li><a href="TelegramBot.html#event:supergroup_chat_created">supergroup_chat_created</a></li><li><a href="TelegramBot.html#event:text">text</a></li><li><a href="TelegramBot.html#event:update">update</a></li><li><a href="TelegramBot.html#event:video">video</a></li><li><a href="TelegramBot.html#event:voice">voice</a></li><li><a href="UpdateGetter.html#event:chosen_inline_result">chosen_inline_result</a></li><li><a href="UpdateGetter.html#event:error">error</a></li><li><a href="UpdateGetter.html#event:inline_query">inline_query</a></li><li><a href="UpdateGetter.html#event:message">message</a></li><li><a href="UpdateGetter.html#event:update">update</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Jan 22 2016 17:29:48 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
